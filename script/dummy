from pymongo import MongoClient
import os
import json
WORKING_DIR = os.getcwd()


def start_mongodb():
    client = MongoClient('localhost', 27017)
    mydatabase = client["preprocessor"]
    mycollection = mydatabase["mscdirect.myTable"]
    return mycollection

def record_creator(product_id,attribute_value,mongo_connection):
    #  Check if record exists : update the query if not write a new
    # print(product_id)
    # 
    record_created = {"_id":product_id,"op": "add","path": "/proxducts/"+product_id, "attribute":attribute_value}
    return record_created

def read_file(mongo_connection):

    file_name = "ItemRestrictions.txt"

    with open(WORKING_DIR+"/output/"+file_name) as  input_file:
        for line in input_file:

            pid,value = line.split("\t")
            value=value.replace("\n","")

            check_record = mongo_connection.find_one({"_id":pid},{"_id":0,"path":1,"attribute":1})


            if check_record != None:
                # RECORD EXIST
               
                existing_attribute = json.loads(check_record["attribute"].replace("\'","\"")) # will update later

                print(type(existing_attribute))
                a = existing_attribute

                pass
            else:
                # RECORD DOESN'T EXIST
                record = record_creator(pid,value,mongo_connection)
                rec = mongo_connection.insert_one(record)
                print("{} :{}".format(pid,value))
    pass
def main():
    mongo_connection = start_mongodb()
    # print(mongo_connection)
    
    read_file(mongo_connection)
    # cursor = mongo_connection.find_one({"_id":"89855228"},{"_id":0,"path":1,"op":1})
    # print(cursor)
    # for x in cursor:
    #     print(x)

if __name__ == "__main__":
    main()
    